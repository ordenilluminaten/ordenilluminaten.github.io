<!DOCTYPE html>
<html>

<head>
	<title>VivaGraphs constant layout demo page</title>
	<style type="text/css" media="screen">
		body,
		html,
		svg {
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
	</style>
</head>

<body>
	<script src="https://vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>
	<script src="libs\vivagraphjs\vivagraph.min.js"></script>

	<script type='text/javascript'>
		class SocialGraphDrawer {
			constructor() {
				this.nodes = {};
				this._initGraph();
			}

			loadFriends(nodeId) {
				VK.api("friends.get", { "user_id": nodeId, "fields": "domain,photo_50" }, (data) => {
					var res = data.response;
					this._render(res.items, nodeId);
				});
			}

			_initGraph() {
				this.graphics = Viva.Graph.View.svgGraphics();

				this.defs = Viva.Graph.svg('defs');
				this.graphics.getSvgRoot().append(this.defs);

				//clip image to circle
				const clippath = Viva.Graph.svg('clipPath')
					.attr('id', 'clip')
					.attr('patternUnits', "userSpaceOnUse");
				const circle = Viva.Graph.svg('circle')
					.attr('cx', '10')
					.attr('cy', '10')
					.attr('r', '10');
				clippath.append(circle);
				this.defs.append(clippath);

				this.graphics.node((node) => {
					const ui = Viva.Graph.svg('g');
					const image = Viva.Graph.svg('image')
						.attr('x', '0')
						.attr('y', '0')
						.attr('height', 20)
						.attr('width', 20)
						.attr('clip-path', "url(#clip)")
						.link(node.data.url);
					ui.append(image);
					return ui;
				}).placeNode((nodeUI, pos) => {
					// Shift image to let links go to the center:
					nodeUI.attr('transform', 'translate(' + (pos.x - 12) + ',' + (pos.y - 12) + ')');
				});
				this.graph = Viva.Graph.graph();

				const renderer = Viva.Graph.View.renderer(this.graph, {
					graphics: this.graphics
				});
				renderer.run();

				this._loadCurrentProfile();
			}

			_loadCurrentProfile() {
				VK.api("users.get", { "fields": "domain,photo_50" }, (data) => {
					var res = data.response;
					this._render(res)
					this.loadFriends(res[0].id);
				});
			}

			_render(nodes, parentNodeId = null) {
				this.graph.beginUpdate();
				for (let node in nodes) {
					alert(JSON.stringify(node));
					//if not rendered
					if (this.nodes[node.id] == null) {
						this.nodes[node.id] = node;
						this.graph.addNode(node.id, {
							url: node.photo_50,
						});
					}
					if (parentNodeId != null) {
						this.graph.addLink(parentNodeId, node.id);
					}
				}
				this.graph.endUpdate();
			}
		}

		try {
			VK.init(onInited,
				function () {
					alert('Cannot connect to vk.com')
				}, '5.67');
		} catch (e) {
			window.location = 'https://vk.com/app6138281_46611989';
		}

		let drawer;
		function onInited() {
			drawer = new SocialGraphDrawer();
		}		
	</script>
</body>

</html>